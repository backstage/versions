/* eslint-disable */
//prettier-ignore
module.exports = {
name: "@yarnpkg/plugin-backstage",
factory: function (require) {
"use strict";var plugin=(()=>{var ur=Object.create;var $=Object.defineProperty;var fr=Object.getOwnPropertyDescriptor;var pr=Object.getOwnPropertyNames;var lr=Object.getPrototypeOf,gr=Object.prototype.hasOwnProperty;var c=(e=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(e,{get:(r,t)=>(typeof require<"u"?require:r)[t]}):e)(function(e){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')});var l=(e,r)=>()=>(r||e((r={exports:{}}).exports,r),r.exports),mr=(e,r)=>{for(var t in r)$(e,t,{get:r[t],enumerable:!0})},ce=(e,r,t,n)=>{if(r&&typeof r=="object"||typeof r=="function")for(let o of pr(r))!gr.call(e,o)&&o!==t&&$(e,o,{get:()=>r[o],enumerable:!(n=fr(r,o))||n.enumerable});return e};var A=(e,r,t)=>(t=e!=null?ur(lr(e)):{},ce(r||!e||!e.__esModule?$(t,"default",{value:e,enumerable:!0}):t,e)),dr=e=>ce($({},"__esModule",{value:!0}),e);var ge=l((ft,le)=>{le.exports=pe;pe.sync=wr;var ue=c("fs");function yr(e,r){var t=r.pathExt!==void 0?r.pathExt:process.env.PATHEXT;if(!t||(t=t.split(";"),t.indexOf("")!==-1))return!0;for(var n=0;n<t.length;n++){var o=t[n].toLowerCase();if(o&&e.substr(-o.length).toLowerCase()===o)return!0}return!1}function fe(e,r,t){return!e.isSymbolicLink()&&!e.isFile()?!1:yr(r,t)}function pe(e,r,t){ue.stat(e,function(n,o){t(n,n?!1:fe(o,e,r))})}function wr(e,r){return fe(ue.statSync(e),e,r)}});var we=l((pt,ye)=>{ye.exports=de;de.sync=Er;var me=c("fs");function de(e,r,t){me.stat(e,function(n,o){t(n,n?!1:he(o,r))})}function Er(e,r){return he(me.statSync(e),r)}function he(e,r){return e.isFile()&&xr(e,r)}function xr(e,r){var t=e.mode,n=e.uid,o=e.gid,s=r.uid!==void 0?r.uid:process.getuid&&process.getuid(),i=r.gid!==void 0?r.gid:process.getgid&&process.getgid(),a=parseInt("100",8),u=parseInt("010",8),f=parseInt("001",8),d=a|u,g=t&f||t&u&&o===i||t&a&&n===s||t&d&&s===0;return g}});var xe=l((gt,Ee)=>{var lt=c("fs"),B;process.platform==="win32"||global.TESTING_WINDOWS?B=ge():B=we();Ee.exports=_;_.sync=vr;function _(e,r,t){if(typeof r=="function"&&(t=r,r={}),!t){if(typeof Promise!="function")throw new TypeError("callback not provided");return new Promise(function(n,o){_(e,r||{},function(s,i){s?o(s):n(i)})})}B(e,r||{},function(n,o){n&&(n.code==="EACCES"||r&&r.ignoreErrors)&&(n=null,o=!1),t(n,o)})}function vr(e,r){try{return B.sync(e,r||{})}catch(t){if(r&&r.ignoreErrors||t.code==="EACCES")return!1;throw t}}});var Oe=l((mt,Se)=>{var v=process.platform==="win32"||process.env.OSTYPE==="cygwin"||process.env.OSTYPE==="msys",ve=c("path"),kr=v?";":":",ke=xe(),Pe=e=>Object.assign(new Error(`not found: ${e}`),{code:"ENOENT"}),be=(e,r)=>{let t=r.colon||kr,n=e.match(/\//)||v&&e.match(/\\/)?[""]:[...v?[process.cwd()]:[],...(r.path||process.env.PATH||"").split(t)],o=v?r.pathExt||process.env.PATHEXT||".EXE;.CMD;.BAT;.COM":"",s=v?o.split(t):[""];return v&&e.indexOf(".")!==-1&&s[0]!==""&&s.unshift(""),{pathEnv:n,pathExt:s,pathExtExe:o}},Re=(e,r,t)=>{typeof r=="function"&&(t=r,r={}),r||(r={});let{pathEnv:n,pathExt:o,pathExtExe:s}=be(e,r),i=[],a=f=>new Promise((d,g)=>{if(f===n.length)return r.all&&i.length?d(i):g(Pe(e));let m=n[f],b=/^".*"$/.test(m)?m.slice(1,-1):m,E=ve.join(b,e),U=!b&&/^\.[\\\/]/.test(e)?e.slice(0,2)+E:E;d(u(U,f,0))}),u=(f,d,g)=>new Promise((m,b)=>{if(g===o.length)return m(a(d+1));let E=o[g];ke(f+E,{pathExt:s},(U,cr)=>{if(!U&&cr)if(r.all)i.push(f+E);else return m(f+E);return m(u(f,d,g+1))})});return t?a(0).then(f=>t(null,f),t):a(0)},Pr=(e,r)=>{r=r||{};let{pathEnv:t,pathExt:n,pathExtExe:o}=be(e,r),s=[];for(let i=0;i<t.length;i++){let a=t[i],u=/^".*"$/.test(a)?a.slice(1,-1):a,f=ve.join(u,e),d=!u&&/^\.[\\\/]/.test(e)?e.slice(0,2)+f:f;for(let g=0;g<n.length;g++){let m=d+n[g];try{if(ke.sync(m,{pathExt:o}))if(r.all)s.push(m);else return m}catch{}}}if(r.all&&s.length)return s;if(r.nothrow)return null;throw Pe(e)};Se.exports=Re;Re.sync=Pr});var Ce=l((dt,M)=>{"use strict";var Te=(e={})=>{let r=e.env||process.env;return(e.platform||process.platform)!=="win32"?"PATH":Object.keys(r).reverse().find(n=>n.toUpperCase()==="PATH")||"Path"};M.exports=Te;M.exports.default=Te});var Be=l((ht,De)=>{"use strict";var $e=c("path"),br=Oe(),Rr=Ce();function Ae(e,r){let t=e.options.env||process.env,n=process.cwd(),o=e.options.cwd!=null,s=o&&process.chdir!==void 0&&!process.chdir.disabled;if(s)try{process.chdir(e.options.cwd)}catch{}let i;try{i=br.sync(e.command,{path:t[Rr({env:t})],pathExt:r?$e.delimiter:void 0})}catch{}finally{s&&process.chdir(n)}return i&&(i=$e.resolve(o?e.options.cwd:"",i)),i}function Sr(e){return Ae(e)||Ae(e,!0)}De.exports=Sr});var Ne=l((yt,H)=>{"use strict";var W=/([()\][%!^"`<>&|;, *?])/g;function Or(e){return e=e.replace(W,"^$1"),e}function Tr(e,r){return e=`${e}`,e=e.replace(/(?=(\\+?)?)\1"/g,'$1$1\\"'),e=e.replace(/(?=(\\+?)?)\1$/,"$1$1"),e=`"${e}"`,e=e.replace(W,"^$1"),r&&(e=e.replace(W,"^$1")),e}H.exports.command=Or;H.exports.argument=Tr});var je=l((wt,Le)=>{"use strict";Le.exports=/^#!(.*)/});var Ie=l((Et,Ue)=>{"use strict";var Cr=je();Ue.exports=(e="")=>{let r=e.match(Cr);if(!r)return null;let[t,n]=r[0].replace(/#! ?/,"").split(" "),o=t.split("/").pop();return o==="env"?n:n?`${o} ${n}`:o}});var Ve=l((xt,Fe)=>{"use strict";var q=c("fs"),$r=Ie();function Ar(e){let t=Buffer.alloc(150),n;try{n=q.openSync(e,"r"),q.readSync(n,t,0,150,0),q.closeSync(n)}catch{}return $r(t.toString())}Fe.exports=Ar});var He=l((vt,We)=>{"use strict";var Dr=c("path"),_e=Be(),Me=Ne(),Br=Ve(),Nr=process.platform==="win32",Lr=/\.(?:com|exe)$/i,jr=/node_modules[\\/].bin[\\/][^\\/]+\.cmd$/i;function Ur(e){e.file=_e(e);let r=e.file&&Br(e.file);return r?(e.args.unshift(e.file),e.command=r,_e(e)):e.file}function Ir(e){if(!Nr)return e;let r=Ur(e),t=!Lr.test(r);if(e.options.forceShell||t){let n=jr.test(r);e.command=Dr.normalize(e.command),e.command=Me.command(e.command),e.args=e.args.map(s=>Me.argument(s,n));let o=[e.command].concat(e.args).join(" ");e.args=["/d","/s","/c",`"${o}"`],e.command=process.env.comspec||"cmd.exe",e.options.windowsVerbatimArguments=!0}return e}function Fr(e,r,t){r&&!Array.isArray(r)&&(t=r,r=null),r=r?r.slice(0):[],t=Object.assign({},t);let n={command:e,args:r,options:t,file:void 0,original:{command:e,args:r}};return t.shell?n:Ir(n)}We.exports=Fr});var ze=l((kt,Ge)=>{"use strict";var G=process.platform==="win32";function z(e,r){return Object.assign(new Error(`${r} ${e.command} ENOENT`),{code:"ENOENT",errno:"ENOENT",syscall:`${r} ${e.command}`,path:e.command,spawnargs:e.args})}function Vr(e,r){if(!G)return;let t=e.emit;e.emit=function(n,o){if(n==="exit"){let s=qe(o,r);if(s)return t.call(e,"error",s)}return t.apply(e,arguments)}}function qe(e,r){return G&&e===1&&!r.file?z(r.original,"spawn"):null}function _r(e,r){return G&&e===1&&!r.file?z(r.original,"spawnSync"):null}Ge.exports={hookChildProcess:Vr,verifyENOENT:qe,verifyENOENTSync:_r,notFoundError:z}});var Ke=l((Pt,k)=>{"use strict";var Je=c("child_process"),J=He(),Y=ze();function Ye(e,r,t){let n=J(e,r,t),o=Je.spawn(n.command,n.args,n.options);return Y.hookChildProcess(o,n),o}function Mr(e,r,t){let n=J(e,r,t),o=Je.spawnSync(n.command,n.args,n.options);return o.error=o.error||Y.verifyENOENTSync(o.status,n),o}k.exports=Ye;k.exports.spawn=Ye;k.exports.sync=Mr;k.exports._parse=J;k.exports._enoent=Y});var Qe=l((Rt,Xe)=>{"use strict";var K=class e extends Error{constructor(r){super(e._prepareSuperMessage(r)),Object.defineProperty(this,"name",{value:"NonError",configurable:!0,writable:!0}),Error.captureStackTrace&&Error.captureStackTrace(this,e)}static _prepareSuperMessage(r){try{return JSON.stringify(r)}catch{return String(r)}}},Wr=[{property:"name",enumerable:!1},{property:"message",enumerable:!1},{property:"stack",enumerable:!1},{property:"code",enumerable:!0}],X=Symbol(".toJSON called"),Hr=e=>{e[X]=!0;let r=e.toJSON();return delete e[X],r},Q=({from:e,seen:r,to_:t,forceEnumerable:n,maxDepth:o,depth:s})=>{let i=t||(Array.isArray(e)?[]:{});if(r.push(e),s>=o)return i;if(typeof e.toJSON=="function"&&e[X]!==!0)return Hr(e);for(let[a,u]of Object.entries(e)){if(typeof Buffer=="function"&&Buffer.isBuffer(u)){i[a]="[object Buffer]";continue}if(typeof u!="function"){if(!u||typeof u!="object"){i[a]=u;continue}if(!r.includes(e[a])){s++,i[a]=Q({from:e[a],seen:r.slice(),forceEnumerable:n,maxDepth:o,depth:s});continue}i[a]="[Circular]"}}for(let{property:a,enumerable:u}of Wr)typeof e[a]=="string"&&Object.defineProperty(i,a,{value:e[a],enumerable:n?!0:u,configurable:!0,writable:!0});return i},qr=(e,r={})=>{let{maxDepth:t=Number.POSITIVE_INFINITY}=r;return typeof e=="object"&&e!==null?Q({from:e,seen:[],forceEnumerable:!0,maxDepth:t,depth:0}):typeof e=="function"?`[Function: ${e.name||"anonymous"}]`:e},Gr=(e,r={})=>{let{maxDepth:t=Number.POSITIVE_INFINITY}=r;if(e instanceof Error)return e;if(typeof e=="object"&&e!==null&&!Array.isArray(e)){let n=new Error;return Q({from:e,seen:[],to_:n,maxDepth:t,depth:0}),n}return new K(e)};Xe.exports={serializeError:qr,deserializeError:Gr}});var st={};mr(st,{default:()=>ot});var j=c("@yarnpkg/core");var T=c("@yarnpkg/core");var Z=A(c("assert")),or=c("semver"),L=c("@yarnpkg/fslib");var D=A(c("fs")),x=c("path");function hr(e,r){let t=e;for(let n=0;n<1e3;n++){let o=(0,x.resolve)(t,"package.json");if(D.default.existsSync(o)&&r(o))return t;let i=(0,x.dirname)(t);if(i===t)return;t=i}throw new Error(`Iteration limit reached when searching for root package.json at ${e}`)}var h;var I=class{#t;#r;#e;get dir(){if(h)return h.dir;let r=process.cwd();return this.#r!==void 0&&this.#t===r?this.#r:(this.#t=r,this.#e=void 0,this.#r=D.default.realpathSync(r).replace(/^[a-z]:/,t=>t.toLocaleUpperCase("en-US")),this.#r)}get rootDir(){if(h)return h.rootDir;let r=this.dir;return this.#e!==void 0?this.#e:(this.#e=hr(r,t=>{try{let n=D.default.readFileSync(t,"utf8");return!!JSON.parse(n).workspaces}catch(n){throw new Error(`Failed to parse package.json file while searching for root, ${n}`)}})??r,this.#e)}resolve=(...r)=>h?h.resolve(...r):(0,x.resolve)(this.dir,...r);resolveRoot=(...r)=>h?h.resolveRoot(...r):(0,x.resolve)(this.rootDir,...r)},F=new I;var V="backstage.json";var Jr=A(Ke());function P(e){if(typeof e!="object"||e===null||Array.isArray(e))return!1;let r=e;return!(typeof r.name!="string"||r.name===""||typeof r.message!="string")}var Ze=A(Qe());function er(e){if(P(e)){let r=String(e);return r!=="[object Object]"?r:`${e.name}: ${e.message}`}return`unknown error '${e}'`}var N=class extends Error{cause;constructor(r,t){let n=r;if(t!==void 0){let o=er(t);n?n+=`; caused by ${o}`:n=`caused by ${o}`}super(n),Error.captureStackTrace?.(this,this.constructor),(!this.name||this.name==="Error")&&this.constructor.name!=="Error"&&(this.name=this.constructor.name),this.cause=P(t)?t:void 0}};var R=class extends N{constructor(r,t){super(r,t),this.name=P(t)?t.name:"Error"}};var rr=e=>{let r=!1,t;return()=>(r||(t=e(),r=!0),t)};var tr=c("@yarnpkg/fslib");var nr=()=>tr.npath.toPortablePath(F.rootDir);var S=rr(()=>{let e=L.ppath.join(nr(),V),r=null;try{let t=L.xfs.readJsonSync(e).version;(0,Z.default)(t!==void 0,"Version field is missing"),r=(0,or.valid)(t),(0,Z.default)(r!==null,"Version exists but is not valid semver")}catch(t){throw new R("Valid version string not found in backstage.json",t)}return r});var O=c("@yarnpkg/core"),sr=c("@yarnpkg/fslib");var Yr="https://versions.backstage.io",Kr="https://raw.githubusercontent.com/backstage/versions/main";function Xr(e,r){return new Promise((t,n)=>{let o=setTimeout(()=>{r.aborted||t()},e);r.addEventListener("abort",()=>{clearTimeout(o),n(new Error("Aborted"))})})}async function Qr(e,r,t){let n=new AbortController,o=new AbortController,s=e(n.signal).then(a=>(o.abort(),a)),i=Xr(t,o.signal).then(()=>r(o.signal)).then(a=>(n.abort(),a));return Promise.any([s,i]).catch(()=>s)}async function ee(e){let r=encodeURIComponent(e.version),t=e.fetch??fetch,n=e.versionsBaseUrl??Yr,o=e.gitHubRawBaseUrl??Kr,s=await Qr(i=>t(`${n}/v1/releases/${r}/manifest.json`,{signal:i}),i=>t(`${o}/v1/releases/${r}/manifest.json`,{signal:i}),500);if(s.status===404)throw new Error(`No release found for ${e.version} version`);if(s.status!==200)throw new Error(`Unexpected response status ${s.status} when fetching release from ${s.url}.`);return s.json()}var p="backstage:";var re=c("process"),w=async(e,r)=>{let t=O.structUtils.stringifyIdent(e),n=O.structUtils.parseRange(e.range);if(n.protocol!==p)throw new Error(`Unsupported version protocol in version range "${e.range}" for package ${t}`);if(n.selector!=="^")throw new Error(`Unexpected version selector "${n.selector}" for package ${t}`);let o=S(),s=re.env.BACKSTAGE_MANIFEST_FILE,a=(s?await sr.xfs.readJsonSync(s):await ee({version:o,versionsBaseUrl:re.env.BACKSTAGE_VERSIONS_BASE_URL,fetch:async u=>{let f=await O.httpUtils.get(u,{configuration:r,jsonResponse:!0});return{status:200,url:u,json:()=>f}}})).packages.find(u=>u.name===t);if(!a)throw new Error(`Package ${t} not found in manifest for Backstage v${o}. This means the specified package is not included in this Backstage release. This may imply the package has been replaced with an alternative - please review the documentation for the package. If you need to continue using this package, it will be necessary to switch to manually managing its version.`);return a.version};var Zr=e=>T.structUtils.parseRange(e).protocol===p,et=(e,r,t)=>e!=="dependencies"?e:t.manifest.ensureDependencyMeta(T.structUtils.makeDescriptor(r,"unknown")).optional?"optionalDependencies":e,te=async(e,r)=>{for(let t of["dependencies","devDependencies"]){let n=Array.from(e.manifest.getForScope(t).values()).filter(o=>o.range.startsWith(p));for(let o of n){let s=T.structUtils.stringifyIdent(o);if(T.structUtils.parseRange(o.range).selector!=="^")throw new Error(`Unexpected version range "${o.range}" for dependency on "${s}"`);let a=et(t,o,e);r[a][s]=`^${await w(o,e.project.configuration)}`}}if(["dependencies","devDependencies","optionalDependencies"].some(t=>Object.values(r[t]??{}).some(Zr)))throw new Error(`Failed to replace all "backstage:" ranges in manifest for ${r.name}`)};var ne=c("@yarnpkg/core");var oe=async(e,r)=>{let t=ne.structUtils.parseRange(e.range);if(t.protocol!==p)return e;if(t.selector!=="^")throw new Error(`Invalid backstage: version range found: ${e.range}`);return ne.structUtils.bindDescriptor(e,{backstage:S(),npm:await w(e,r.configuration)})};var ir=c("@yarnpkg/core");var se=async(e,r,t,n)=>{let o=ir.structUtils.parseRange(t.range);if(t.scope==="backstage"&&o.protocol!==p){let s=t.range;try{t.range=`${p}^`,await w(t,e.project.configuration),console.info(`Setting ${t.scope}/${t.name} to ${p}^`)}catch{t.range=s}}};var ar=c("@yarnpkg/core");var ie=async(e,r,t,n)=>{let o=ar.structUtils.parseRange(n.range);n.scope==="backstage"&&o.protocol!==p&&console.warn(`${n.name} should be set to "${p}^" instead of "${n.range}". Make sure this change is intentional and not a mistake.`)};var y=c("@yarnpkg/core"),ae=c("@yarnpkg/plugin-npm");var C=class e{static protocol=p;supportsDescriptor=r=>r.range.startsWith(e.protocol);async getCandidates(r,t,n){let o=y.structUtils.parseRange(r.range).params?.npm;if(!o||Array.isArray(o))throw new Error(`Missing npm parameter on backstage: range "${r.range}"`);return new ae.NpmSemverResolver().getCandidates(y.structUtils.makeDescriptor(r,`npm:^${o}`),t,n)}getResolutionDependencies(r){let t=y.structUtils.parseRange(r.range).params?.npm;if(!t)throw new Error(`Missing npm parameter on backstage: range "${r.range}".`);return{[y.structUtils.stringifyIdent(r)]:y.structUtils.makeDescriptor(r,`npm:^${t}`)}}async getSatisfying(r,t,n,o){let s=r,i=y.structUtils.parseRange(s.range);if(i.protocol===p){let a=i.params?.npm;s=y.structUtils.makeDescriptor(r,`npm:^${a}`)}return new ae.NpmSemverResolver().getSatisfying(s,t,n,o)}bindDescriptor=r=>r;supportsLocator=()=>!1;shouldPersistResolution=()=>{throw new Error("Unreachable: BackstageNpmResolver should never persist resolution as it uses npm: protocol")};resolve=async()=>{throw new Error("Unreachable: BackstageNpmResolver should never resolve as it uses npm: protocol")}};var rt="\x1B[31;1m",tt="\x1B[0m";j.semverUtils.satisfiesWithPrereleases(j.YarnVersion,"^4.1.1")||(console.error(),console.error(`${rt}Unsupported yarn version${tt}: The Backstage yarn plugin only works with yarn ^4.1.1. Please upgrade yarn, or remove this plugin with "yarn plugin remove @yarnpkg/plugin-backstage".`),console.error());var nt={hooks:{afterWorkspaceDependencyAddition:se,afterWorkspaceDependencyReplacement:ie,reduceDependency:oe,beforeWorkspacePacking:te},resolvers:[C]},ot=nt;return dr(st);})();
return plugin;
}
};
